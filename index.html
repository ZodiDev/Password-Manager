<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Password Manager</title>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;padding:10px;line-height:1.5
    }
    .container{max-width:450px;margin:0 auto;background:rgba(255,255,255,.95);backdrop-filter:blur(20px);border-radius:20px;box-shadow:0 8px 32px rgba(0,0,0,.1);overflow:hidden;border:1px solid rgba(255,255,255,.2)}
    @media (min-width:768px){.container{max-width:800px}}
    @media (min-width:1024px){.container{max-width:1200px}}
    @media (min-width:1400px){.container{max-width:1400px}}
    .header{background:linear-gradient(135deg,#2c3e50,#34495e);color:#fff;padding:20px;text-align:center;position:relative}
    .header h1{font-size:1.4rem;margin-bottom:5px;font-weight:700}
    .header p{font-size:.85rem;opacity:.9}
    .sync-status{position:absolute;top:15px;right:15px;padding:4px 8px;border-radius:12px;font-size:.7rem;font-weight:600}
    .sync-online{background:rgba(39,174,96,.9);color:#fff}
    .sync-offline{background:rgba(231,76,60,.9);color:#fff}
    .section{padding:20px}
    .section-mobile{padding:15px}
    .info,.warning{padding:12px;border-radius:10px;margin-bottom:15px;font-size:.9rem}
    .info{background:linear-gradient(135deg,#e3f2fd,#bbdefb);border-left:4px solid #2196f3;color:#1565c0}
    .warning{background:linear-gradient(135deg,#fff3e0,#ffcc02);border-left:4px solid #ff9800;color:#e65100}
    .form-group{margin-bottom:15px}
    .form-group-compact{margin-bottom:12px}
    label{display:block;margin-bottom:6px;font-weight:600;color:#2c3e50;font-size:.9rem}
    .input-container{position:relative}
    input[type="text"],input[type="password"],input[type="url"],textarea{
      width:100%;padding:12px;border:2px solid #e9ecef;border-radius:10px;font-size:16px;transition:.3s;background:rgba(255,255,255,.9)
    }
    input:focus,textarea:focus{outline:none;border-color:#3498db;background:#fff;transform:translateY(-1px);box-shadow:0 4px 12px rgba(52,152,219,.15)}
    .password-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:1.2rem;color:#6c757d;padding:0;z-index:2}
    .password-toggle:hover{color:#3498db}
    .btn{width:100%;background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;border:none;padding:14px 20px;border-radius:10px;cursor:pointer;font-size:1rem;font-weight:600;transition:.3s;margin-bottom:10px;position:relative;overflow:hidden}
    .btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 25px rgba(52,152,219,.3)}
    .btn:active{transform:translateY(0)}
    .btn:disabled{opacity:.7;cursor:not-allowed;transform:none!important}
    .btn-primary{background:linear-gradient(135deg,#3498db,#2980b9)}
    .btn-success{background:linear-gradient(135deg,#27ae60,#229954)}
    .btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b)}
    .btn-secondary{background:linear-gradient(135deg,#95a5a6,#7f8c8d);font-size:.9rem;padding:10px 16px}
    .btn-row{display:flex;gap:8px;margin-bottom:10px}
    .btn-row .btn{margin-bottom:0}
    .password-item{background:rgba(255,255,255,.9);border-radius:12px;padding:15px;margin-bottom:12px;border:1px solid rgba(0,0,0,.05);transition:.3s;position:relative}
    .password-item:hover{transform:translateY(-1px);box-shadow:0 4px 20px rgba(0,0,0,.1)}
    .password-item.new-password{border-left:4px solid #27ae60;background:rgba(39,174,96,.05)}
    .password-item h3{color:#2c3e50;margin-bottom:8px;font-size:1.1rem;display:flex;align-items:center;gap:8px}
    .password-item .site-icon{width:20px;height:20px;border-radius:4px;background:linear-gradient(135deg,#3498db,#2980b9);display:flex;align-items:center;justify-content:center;color:#fff;font-size:.8rem;font-weight:bold}
    .password-item p{margin:4px 0;color:#6c757d;font-size:.9rem}
    .password-display{font-family:Monaco,Menlo,'Ubuntu Mono',monospace;background:rgba(236,240,241,.8);padding:8px;border-radius:6px;word-break:break-all;margin:8px 0;font-size:.9rem;border-left:3px solid #3498db}
    .hidden{display:none!important}
    .add-form{background:rgba(248,249,250,.8);padding:15px;border-radius:12px;margin-bottom:20px;border:1px solid rgba(0,0,0,.05)}
    .add-form h3{margin-bottom:15px;color:#2c3e50;font-size:1.1rem;text-align:center}
    .form-row{display:flex;gap:10px;margin-bottom:12px}
    .form-row .form-group{flex:1;margin-bottom:0}
    .quick-actions{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:6px;margin-top:10px}
    .quick-actions .btn{margin-bottom:0;font-size:.8rem;padding:8px 10px}
    .passwords-grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:768px){.passwords-grid{grid-template-columns:repeat(2,1fr);gap:15px}}
    @media (min-width:1024px){.passwords-grid{grid-template-columns:repeat(3,1fr);gap:15px}}
    @media (min-width:1400px){.passwords-grid{grid-template-columns:repeat(4,1fr);gap:15px}}
    .search-container{position:relative;margin-bottom:15px}
    .search-input{background:rgba(255,255,255,.9)}
    .clear-search{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:#6c757d;cursor:pointer;padding:0;font-size:1.2rem}
    .password-strength{height:4px;border-radius:2px;margin-top:6px;transition:.3s}
    .strength-weak{background:linear-gradient(90deg,#e74c3c,#c0392b)}
    .strength-medium{background:linear-gradient(90deg,#f39c12,#e67e22)}
    .strength-strong{background:linear-gradient(90deg,#27ae60,#229954)}
    .loading,.empty-state{text-align:center;padding:40px 20px;color:#7f8c8d}
    .empty-state-icon{font-size:3rem;margin-bottom:15px;opacity:.6}
    .steps{text-align:left;margin:15px 0}
    .steps ol{padding-left:20px}
    .steps li{margin-bottom:8px;font-size:.9rem}
    .copy-feedback{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(39,174,96,.95);color:#fff;padding:12px 20px;border-radius:10px;font-weight:600;z-index:1000;opacity:0;transition:opacity .3s}
    .copy-feedback.show{opacity:1}
    
    /* Custom Confirmation Dialog */
    .custom-confirm-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }
    .custom-confirm-dialog {
      background: white;
      border-radius: 15px;
      padding: 25px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      text-align: center;
    }
    .custom-confirm-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 15px;
    }
    .custom-confirm-message {
      color: #7f8c8d;
      margin-bottom: 25px;
      line-height: 1.5;
    }
    .custom-confirm-buttons {
      display: flex;
      gap: 10px;
    }
    .custom-confirm-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .custom-confirm-btn.cancel {
      background: #ecf0f1;
      color: #7f8c8d;
    }
    .custom-confirm-btn.cancel:hover {
      background: #d5dbdb;
    }
    .custom-confirm-btn.delete {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
    }
    .custom-confirm-btn.delete:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    }
    
    @media (max-width:480px){
      body{padding:5px}
      .container{border-radius:15px;max-width:100%}
      .header{padding:15px}
      .header h1{font-size:1.2rem}
      .section{padding:15px}
      .form-row{flex-direction:column;gap:0}
      .form-row .form-group{margin-bottom:12px}
      .quick-actions{grid-template-columns:1fr 1fr}
      .password-item{padding:12px}
      .custom-confirm-dialog{padding:20px;margin:10px}
    }
    @media (prefers-color-scheme:dark){
      .container{background:rgba(45,52,65,.95);color:#e9ecef}
      input,textarea{background:rgba(75,85,99,.9)!important;color:#f1f5f9!important;border-color:#64748b}
      input:focus,textarea:focus{background:rgba(51,65,85,.95)!important;border-color:#3498db;color:#f1f5f9!important}
      input::placeholder,textarea::placeholder{color:#94a3b8!important}
      .password-item{background:rgba(55,65,81,.9);color:#e9ecef}
      .password-item.new-password{border-left:4px solid #27ae60;background:rgba(39,174,96,.15)}
      .password-item h3{color:#e9ecef!important}
      .password-item p{color:#cbd5e0!important}
      .add-form{background:rgba(55,65,81,.8)}
      .password-display{background:rgba(75,85,99,.8);color:#e9ecef!important}
      label{color:#e9ecef}
      .info{background:rgba(59,130,246,.2);color:#dbeafe;border-left:4px solid #3b82f6}
      .warning{background:rgba(245,158,11,.2);color:#fef3c7;border-left:4px solid #f59e0b}
      .custom-confirm-dialog{background:rgba(45,52,65,.98);color:#e9ecef}
      .custom-confirm-title{color:#e9ecef}
      .custom-confirm-message{color:#cbd5e0}
      .custom-confirm-btn.cancel{background:rgba(75,85,99,.9);color:#cbd5e0}
      .custom-confirm-btn.cancel:hover{background:rgba(55,65,81,.9)}
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üîê Password Manager</h1>
      <p>Secure ‚Ä¢ Synced ‚Ä¢ Simple</p>
      <div class="sync-status sync-offline" id="syncStatus">‚ö´ Offline</div>
    </div>

    <!-- GitHub Setup -->
    <div class="section" id="setupSection">
      <div class="warning">
        <strong>‚ö†Ô∏è First Time Setup</strong><br>
        Configure GitHub sync to access your passwords anywhere.
      </div>

      <div class="steps">
        <h4>Quick Setup:</h4>
        <ol>
          <li>Create a <strong>private</strong> GitHub repository</li>
          <li>Generate a token with <strong>Contents Read and write</strong> permissions</li>
          <li>Enter details below</li>
        </ol>
      </div>

      <div class="form-group-compact">
        <label for="githubUsername">GitHub Username</label>
        <input type="text" id="githubUsername" placeholder="your-username">
      </div>

      <div class="form-group-compact">
        <label for="repoName">Repository Name</label>
        <input type="text" id="repoName" placeholder="my-passwords">
      </div>

      <div class="form-group-compact">
        <label for="githubToken">Access Token</label>
        <div class="input-container">
          <input type="password" id="githubToken" placeholder="github_pat_...">
          <button class="password-toggle" onclick="togglePasswordVisibility('githubToken')">üëÅÔ∏è</button>
        </div>
      </div>

      <button class="btn btn-success" onclick="saveGitHubConfig()">üöÄ Save & Connect</button>
      <button class="btn btn-secondary" onclick="testGitHubConnection()">üîç Test Connection</button>

      <div style="text-align:center;margin-top:15px">
        <small style="color:#7f8c8d">
          Need help? <a href="#" onclick="skipGitHubCheck()" style="color:#3498db">Skip verification</a>
        </small>
      </div>
    </div>

    <!-- Create Master Password -->
    <div class="section hidden" id="createPasswordSection">
      <div class="info">
        <strong>üîê Create Master Password</strong><br>
        This encrypts all your passwords. Make it strong and memorable.
      </div>

      <div class="form-group-compact">
        <label for="newMasterPassword">Master Password</label>
        <div class="input-container">
          <input type="password" id="newMasterPassword" placeholder="Create a strong password" onkeypress="if(event.key==='Enter') createMasterPassword()" oninput="checkPasswordStrength(this.value)">
          <button class="password-toggle" onclick="togglePasswordVisibility('newMasterPassword')">üëÅÔ∏è</button>
        </div>
        <div class="password-strength" id="strengthIndicator"></div>
      </div>

      <div class="form-group-compact">
        <label for="confirmMasterPassword">Confirm Password</label>
        <div class="input-container">
          <input type="password" id="confirmMasterPassword" placeholder="Confirm your password" onkeypress="if(event.key==='Enter') createMasterPassword()">
          <button class="password-toggle" onclick="togglePasswordVisibility('confirmMasterPassword')">üëÅÔ∏è</button>
        </div>
      </div>

      <button class="btn btn-success" id="createBtn" onclick="createMasterPassword()">üîë Create Vault</button>
      <button class="btn btn-secondary" onclick="switchToLogin()">Already Have a Vault</button>
    </div>

    <!-- Login -->
    <div class="section hidden" id="authSection">
      <div class="info">
        <strong>üîê Welcome Back</strong><br>
        Enter your master password to unlock your vault.
      </div>

      <div class="form-group-compact">
        <label for="masterPassword">Master Password</label>
        <div class="input-container">
          <input type="password" id="masterPassword" placeholder="Enter your master password" onkeypress="if(event.key==='Enter') authenticate()">
          <button class="password-toggle" onclick="togglePasswordVisibility('masterPassword')">üëÅÔ∏è</button>
        </div>
      </div>

      <button class="btn btn-primary" id="unlockBtn" onclick="authenticate()">üîì Unlock Vault</button>
      <button class="btn btn-secondary" onclick="switchToCreate()">Create New Vault</button>
    </div>

    <!-- Main -->
    <div class="section-mobile hidden" id="mainSection">
      <div style="text-align:center;margin-bottom:20px">
        <button class="btn btn-success" id="toggleAddBtn" onclick="toggleAddForm()">‚ûï Add New Password</button>
      </div>

      <div class="add-form hidden" id="addPasswordForm">
        <h3>‚ûï Add New Password</h3>

        <div class="form-row">
          <div class="form-group">
            <label for="siteName">Site or Service</label>
            <input type="text" id="siteName" placeholder="Gmail, Facebook...">
          </div>
          <div class="form-group">
            <label for="siteUrl">URL optional</label>
            <input type="url" id="siteUrl" placeholder="https://...">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="username">Username or Email</label>
            <input type="text" id="username" placeholder="your@email.com">
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <div class="input-container">
              <input type="password" id="password" placeholder="Your password">
              <button class="password-toggle" onclick="togglePasswordVisibility('password')">üëÅÔ∏è</button>
            </div>
          </div>
        </div>

        <div class="btn-row">
          <button class="btn btn-success" id="addBtn" onclick="addPassword()">üíæ Save</button>
          <button class="btn btn-secondary" onclick="generatePassword()">üé≤ Generate</button>
        </div>
      </div>

      <div class="search-container">
        <input type="text" class="search-input" id="searchInput" placeholder="Search passwords..." oninput="filterPasswords()">
        <button class="clear-search hidden" id="clearSearch" onclick="clearSearch()">‚úï</button>
      </div>

      <div class="btn-row" style="margin-bottom:15px">
        <button class="btn btn-secondary" onclick="document.getElementById('csvImport').click()">üì• Import CSV</button>
        <button class="btn btn-secondary" onclick="exportCSV()">üì§ Export CSV</button>
      </div>
      <input type="file" id="csvImport" accept=".csv" style="display:none" onchange="handleCSVImport()">

      <div id="passwordsList">
        <div class="loading">Loading your passwords...</div>
      </div>

      <div style="margin-top:20px">
        <div class="btn-row">
          <button class="btn btn-secondary" id="syncBtn" onclick="syncNow()">üîÑ Sync</button>
          <button class="btn btn-danger" onclick="logout()">üîí Lock</button>
        </div>
      </div>
    </div>
  </div>

  <div class="copy-feedback" id="copyFeedback">üìã Copied!</div>

  <script>
    let masterKey = null;
    let passwords = [];
    let githubConfig = null;
    let filteredPasswords = [];
    let lastSyncTime = null;
    let newPasswordsThisSession = new Set();
    let isOperationInProgress = false; // Prevent concurrent operations
    let lastSyncHash = ''; // Track changes to avoid unnecessary syncs

    // startup
    window.addEventListener('load', () => {
      const saved = localStorage.getItem('githubConfig');
      if (saved) {
        githubConfig = JSON.parse(saved);
        githubConfig.username = githubConfig.username.trim();
        githubConfig.repo = githubConfig.repo.trim();
        githubConfig.token = githubConfig.token.trim();
        localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
        document.getElementById('setupSection').style.display = 'none';
        document.getElementById('authSection').classList.remove('hidden');
      }
    });

    // Helper function to generate unique IDs for passwords
    function generatePasswordId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // Helper function to calculate hash of passwords array for change detection
    function calculatePasswordsHash() {
      return btoa(JSON.stringify(passwords.map(p => ({ id: p.id, siteName: p.siteName, username: p.username, password: p.password }))));
    }

    // Custom confirmation dialog for Android WebView compatibility
    function showCustomConfirm(title, message) {
      return new Promise((resolve) => {
        // Create overlay
        const overlay = document.createElement('div');
        overlay.className = 'custom-confirm-overlay';
        
        // Create dialog
        const dialog = document.createElement('div');
        dialog.className = 'custom-confirm-dialog';
        
        dialog.innerHTML = `
          <div class="custom-confirm-title">${title}</div>
          <div class="custom-confirm-message">${message}</div>
          <div class="custom-confirm-buttons">
            <button class="custom-confirm-btn cancel">Cancel</button>
            <button class="custom-confirm-btn delete">Delete</button>
          </div>
        `;
        
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
        
        // Handle button clicks
        const cancelBtn = dialog.querySelector('.cancel');
        const deleteBtn = dialog.querySelector('.delete');
        
        const cleanup = () => {
          document.body.removeChild(overlay);
        };
        
        cancelBtn.addEventListener('click', () => {
          cleanup();
          resolve(false);
        });
        
        deleteBtn.addEventListener('click', () => {
          cleanup();
          resolve(true);
        });
        
        // Handle click outside dialog
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            cleanup();
            resolve(false);
          }
        });
        
        // Focus on delete button for keyboard users
        setTimeout(() => deleteBtn.focus(), 100);
      });
    }

    // WebView-compatible alert function
    function showAlert(message) {
      showCopyFeedback(message);
    }

    // ui helpers
    function togglePasswordVisibility(id){
      const input = document.getElementById(id);
      const btn = input.nextElementSibling;
      if(input.type==='password'){ input.type='text'; btn.textContent='üôà'; }
      else { input.type='password'; btn.textContent='üëÅÔ∏è'; }
    }

    function checkPasswordStrength(pwd){
      const el = document.getElementById('strengthIndicator');
      if(!el) return;
      let score = 0;
      if(pwd.length>=8) score++;
      if(pwd.length>=12) score++;
      if(/[A-Z]/.test(pwd)) score++;
      if(/[a-z]/.test(pwd)) score++;
      if(/[0-9]/.test(pwd)) score++;
      if(/[^A-Za-z0-9]/.test(pwd)) score++;
      el.style.width = Math.min(score*20,100)+'%';
      if(score<3) el.className='password-strength strength-weak';
      else if(score<5) el.className='password-strength strength-medium';
      else el.className='password-strength strength-strong';
    }

    function updateSyncStatus(text, cls){
      const el = document.getElementById('syncStatus');
      el.textContent = text;
      el.className = 'sync-status ' + cls;
    }

    function updateLastSyncTime(){
      // intentionally empty no separate last sync label in ui
    }

    function switchToLogin(){
      document.getElementById('createPasswordSection').style.display='none';
      document.getElementById('authSection').classList.remove('hidden');
      updateSyncStatus('üîê Ready to unlock','sync-offline');
    }

    function switchToCreate(){
      document.getElementById('authSection').style.display='none';
      document.getElementById('createPasswordSection').classList.remove('hidden');
      updateSyncStatus('üÜï Ready to create','sync-offline');
    }

    function toggleAddForm(){
      const form = document.getElementById('addPasswordForm');
      const btn = document.getElementById('toggleAddBtn');
      if(form.classList.contains('hidden')){
        form.classList.remove('hidden');
        btn.textContent='‚ûñ Hide Add Form';
      }else{
        form.classList.add('hidden');
        btn.textContent='‚ûï Add New Password';
        document.getElementById('siteName').value='';
        document.getElementById('siteUrl').value='';
        document.getElementById('username').value='';
        document.getElementById('password').value='';
      }
    }

    // crypto
    async function deriveKey(password, salt){
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey({name:'PBKDF2', salt, iterations:100000, hash:'SHA-256'}, keyMaterial, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
    }

    async function encrypt(text, key){
      const enc = new TextEncoder();
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, enc.encode(text));
      return { iv: Array.from(iv), data: Array.from(new Uint8Array(ct)) };
    }

    async function decrypt(payload, key){
      const iv = new Uint8Array(payload.iv);
      const data = new Uint8Array(payload.data);
      const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, data);
      return new TextDecoder().decode(pt);
    }

    // github api
    async function githubApiCall(endpoint, method='GET', data=null){
      const url = `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/${endpoint}`;
      const options = {
        method,
        headers:{
          'Authorization': `token ${githubConfig.token}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        }
      };
      if(data) options.body = JSON.stringify(data);
      const res = await fetch(url, options);
      if(!res.ok){
        const txt = await res.text();
        throw new Error(`GitHub API error ${res.status} ${res.statusText} ${txt}`);
      }
      return res.json();
    }

    async function loadPasswordsFromGitHub(){      
      try{
        updateSyncStatus('üîÑ Syncing...','sync-offline');
        const file = await githubApiCall('contents/passwords.json');
        const raw = atob(file.content);
        const encrypted = JSON.parse(raw);
        const json = await decrypt(encrypted, masterKey);
        const remotePasswords = JSON.parse(json);
        
        // Migrate old passwords to include IDs if they don't have them
        remotePasswords.forEach(pwd => {
          if (!pwd.id) {
            pwd.id = generatePasswordId();
          }
        });
        
        passwords = remotePasswords;
        lastSyncTime = new Date();
        lastSyncHash = calculatePasswordsHash();
        updateSyncStatus('üü¢ Synced','sync-online');
        updateLastSyncTime();
      }catch(err){
        if(String(err.message).includes('404')){
          passwords = [];
          await savePasswordsToGitHub();
        }else{
          console.error('Failed to load', err);
          updateSyncStatus('üî¥ Sync Error','sync-offline');
          throw err;
        }
      }
    }

    async function savePasswordsToGitHub(){
      const maxRetries = 3;
      let retryCount = 0;
      
      while(retryCount <= maxRetries) {
        try{
          updateSyncStatus('üîÑ Saving...','sync-offline');
          
          // Ensure all passwords have IDs
          passwords.forEach(pwd => {
            if (!pwd.id) {
              pwd.id = generatePasswordId();
            }
          });
          
          const plaintext = JSON.stringify(passwords);
          const encrypted = await encrypt(plaintext, masterKey);
          const content = btoa(JSON.stringify(encrypted));

          let sha = null;
          try{
            const existing = await githubApiCall('contents/passwords.json');
            sha = existing.sha;
          }catch(_){}

          const commit = {
            message: `Update passwords ${new Date().toISOString()}${retryCount > 0 ? ` (retry ${retryCount})` : ''}`,
            content
          };
          if(sha) commit.sha = sha;

          await githubApiCall('contents/passwords.json', 'PUT', commit);
          lastSyncTime = new Date();
          lastSyncHash = calculatePasswordsHash();
          updateSyncStatus('üü¢ Synced','sync-online');
          updateLastSyncTime();
          return; // Success, exit the retry loop
          
        }catch(err){
          console.error(`Save failed (attempt ${retryCount + 1}):`, err);
          
          if((String(err.message).includes('409') || String(err.message).includes('does not match')) && retryCount < maxRetries){
            retryCount++;
            console.log(`Retrying save operation (${retryCount}/${maxRetries})...`);
            
            // Wait a short time before retrying to avoid rapid-fire requests
            await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
            
            try{
              // Fetch latest remote state
              const remoteFile = await githubApiCall('contents/passwords.json');
              const remoteRaw = atob(remoteFile.content);
              const remoteEncrypted = JSON.parse(remoteRaw);
              const remoteJson = await decrypt(remoteEncrypted, masterKey);
              const remotePasswords = JSON.parse(remoteJson);
              
              // Merge remote passwords with local passwords
              const mergedPasswords = mergePasswordArrays(remotePasswords, passwords);
              passwords = mergedPasswords;
              
              console.log(`Merged ${remotePasswords.length} remote with ${passwords.length} local passwords`);
              // Continue to next retry iteration with merged data
              
            }catch(mergeErr){
              console.error('Failed to merge remote changes:', mergeErr);
              // Continue with local data only
            }
          } else {
            // Non-conflict error or max retries reached
            updateSyncStatus('üî¥ Sync Error','sync-offline');
            throw err;
          }
        }
      }
    }

    // Helper function to intelligently merge password arrays
    function mergePasswordArrays(remotePasswords, localPasswords) {
      const merged = new Map();
      
      // Add all remote passwords first
      remotePasswords.forEach(pwd => {
        if (!pwd.id) pwd.id = generatePasswordId();
        merged.set(pwd.id, pwd);
      });
      
      // Add/update with local passwords
      localPasswords.forEach(pwd => {
        if (!pwd.id) pwd.id = generatePasswordId();
        
        const existing = merged.get(pwd.id);
        if (!existing) {
          // New local password, add it
          merged.set(pwd.id, pwd);
        } else {
          // Password exists in both, prefer local version (local changes take precedence)
          merged.set(pwd.id, pwd);
        }
      });
      
      return Array.from(merged.values());
    }

    // setup actions
    async function testGitHubConnection(){
      const username = document.getElementById('githubUsername').value.trim();
      const repo = document.getElementById('repoName').value.trim();
      const token = document.getElementById('githubToken').value.trim();
      if(!username || !repo || !token){ showAlert('Please fill in all fields first'); return; }

      const original = githubConfig;
      githubConfig = {username, repo, token};

      try{
        updateSyncStatus('üîÑ Testing...','sync-offline');

        const repoInfo = await fetch(`https://api.github.com/repos/${username}/${repo}`,{
          headers:{'Authorization':`token ${token}`,'Accept':'application/vnd.github.v3+json'}
        });
        if(!repoInfo.ok) throw new Error(`Repository access failed ${repoInfo.status}`);

        const write = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/.test-file`,{
          method:'PUT',
          headers:{'Authorization':`token ${token}`,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'},
          body:JSON.stringify({message:'Test file', content:btoa('test')})
        });
        if(!write.ok) throw new Error('Cannot write to repository. Check token permissions.');

        const info = await write.json();
        await fetch(`https://api.github.com/repos/${username}/${repo}/contents/.test-file`,{
          method:'DELETE',
          headers:{'Authorization':`token ${token}`,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'},
          body:JSON.stringify({message:'Clean up test file', sha:info.content.sha})
        });

        updateSyncStatus('‚úÖ Connected','sync-online');
        showAlert('Connection successful. You can now save configuration.');
        localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
        document.getElementById('setupSection').style.display='none';
        document.getElementById('createPasswordSection').classList.remove('hidden');
      }catch(err){
        console.error('Connection test failed', err);
        showAlert(`Connection failed ${err.message}`);
        updateSyncStatus('‚ùå Failed','sync-offline');
      }finally{
        if(!githubConfig) githubConfig = original;
      }
    }

    async function saveGitHubConfig(){
      const username = document.getElementById('githubUsername').value.trim();
      const repo = document.getElementById('repoName').value.trim();
      const token = document.getElementById('githubToken').value.trim();
      if(!username || !repo || !token){ showAlert('Please fill in all fields'); return; }
      if(username.includes(' ') || repo.includes(' ')){ showAlert('Username and repository cannot contain spaces'); return; }

      githubConfig = {username, repo, token};
      localStorage.setItem('githubConfig', JSON.stringify(githubConfig));

      document.getElementById('setupSection').style.display='none';
      updateSyncStatus('üîÑ Checking vault...','sync-offline');

      try{
        await githubApiCall('contents/passwords.json');
        document.getElementById('authSection').classList.remove('hidden');
        updateSyncStatus('üîê Vault found','sync-offline');
      }catch(err){
        if(String(err.message).includes('404')){
          document.getElementById('createPasswordSection').classList.remove('hidden');
          updateSyncStatus('üÜï New vault','sync-offline');
        }else{
          document.getElementById('createPasswordSection').classList.remove('hidden');
          updateSyncStatus('‚ùì Choose option','sync-offline');
        }
      }
    }

    function skipGitHubCheck(){
      const username = document.getElementById('githubUsername').value.trim();
      const repo = document.getElementById('repoName').value.trim();
      const token = document.getElementById('githubToken').value.trim();
      if(!username || !repo || !token){ showAlert('Please fill in all GitHub fields first'); return; }
      githubConfig = {username, repo, token};
      localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
      document.getElementById('setupSection').style.display='none';
      document.getElementById('createPasswordSection').classList.remove('hidden');
      updateSyncStatus('üÜï Ready to create','sync-offline');
    }

    // auth actions
    async function createMasterPassword(){
      const pwd = document.getElementById('newMasterPassword').value;
      const confirm = document.getElementById('confirmMasterPassword').value;
      if(!pwd || !confirm){ showAlert('Please fill in both password fields'); return; }
      if(pwd !== confirm){ showAlert('Passwords do not match'); return; }
      if(pwd.length < 8){ showAlert('Master password must be at least 8 characters long'); return; }

      const btn = document.getElementById('createBtn');
      btn.disabled = true; btn.textContent = 'üîÑ Creating Vault...';
      try{
        const salt = new TextEncoder().encode('password-manager-salt-2024');
        masterKey = await deriveKey(pwd, salt);
        passwords = [];
        newPasswordsThisSession.clear();
        await savePasswordsToGitHub();

        document.getElementById('createPasswordSection').style.display='none';
        document.getElementById('mainSection').classList.remove('hidden');
        document.getElementById('newMasterPassword').value='';
        document.getElementById('confirmMasterPassword').value='';
        displayPasswords();
      }catch(err){
        showAlert('Failed to create vault. Please try again.');
        console.error(err);
      }finally{
        btn.disabled=false; btn.textContent='üîë Create Vault';
      }
    }

    async function authenticate(){
      const pwd = document.getElementById('masterPassword').value;
      if(!pwd){ showAlert('Please enter a master password'); return; }
      const btn = document.getElementById('unlockBtn');
      btn.disabled=true; btn.textContent='üîÑ Unlocking...';
      try{
        const salt = new TextEncoder().encode('password-manager-salt-2024');
        masterKey = await deriveKey(pwd, salt);
        await loadPasswordsFromGitHub();
        newPasswordsThisSession.clear();
        document.getElementById('authSection').style.display='none';
        document.getElementById('mainSection').classList.remove('hidden');
        document.getElementById('masterPassword').value='';
        displayPasswords();
      }catch(err){
        showAlert('Failed to unlock vault. Please check your master password.');
        console.error(err);
      }finally{
        btn.disabled=false; btn.textContent='üîì Unlock Vault';
      }
    }

    // add edit list
    async function addPassword(){
      const siteName = document.getElementById('siteName').value.trim();
      const siteUrl = document.getElementById('siteUrl').value.trim();
      const username = document.getElementById('username').value.trim();
      const pwd = document.getElementById('password').value;
      if(!siteName || !username || !pwd){ showAlert('Please fill in site name, username, and password'); return; }

      const btn = document.getElementById('addBtn');
      btn.disabled = true; btn.textContent='üíæ Saving...';
      try{
        const newPassword = {
          id: generatePasswordId(),
          siteName,
          siteUrl,
          username,
          password: pwd,
          dateAdded: new Date().toISOString()
        };
        
        passwords.push(newPassword);
        newPasswordsThisSession.add(newPassword.id);

        await savePasswordsToGitHub();
        displayPasswords();

        document.getElementById('siteName').value='';
        document.getElementById('siteUrl').value='';
        document.getElementById('username').value='';
        document.getElementById('password').value='';
        showCopyFeedback('‚úÖ Password saved!');
        document.getElementById('addPasswordForm').classList.add('hidden');
        document.getElementById('toggleAddBtn').textContent='‚ûï Add New Password';
      }catch(err){
        showAlert('Failed to save password. Please try again.');
        passwords = passwords.filter(p => p.id !== newPassword.id);
      }finally{
        btn.disabled=false; btn.textContent='üíæ Save';
      }
    }

    function displayPasswords(){
      const container = document.getElementById('passwordsList');
      let list = filteredPasswords.length>0 ? filteredPasswords : passwords;

      if(list.length===0){
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîë</div>
            <strong>No passwords yet</strong><br>
            <small>Add your first password above to get started</small>
          </div>`;
        return;
      }

      // sort new first then alphabetical
      list = [...list].sort((a,b)=>{
        const na = newPasswordsThisSession.has(a.id);
        const nb = newPasswordsThisSession.has(b.id);
        if(na && !nb) return -1;
        if(!na && nb) return 1;
        return a.siteName.toLowerCase().localeCompare(b.siteName.toLowerCase());
      });

      const grid = document.createElement('div');
      grid.className='passwords-grid';

      list.forEach(item=>{
        const first = item.siteName.charAt(0).toUpperCase();
        const isNew = newPasswordsThisSession.has(item.id);
        const div = document.createElement('div');
        div.className = 'password-item' + (isNew ? ' new-password' : '');
        div.innerHTML = `
          <h3><span class="site-icon">${first}</span>${item.siteName}${isNew ? '<span style="color:#27ae60;font-size:.8rem;margin-left:5px">NEW</span>':''}</h3>
          <p><strong>üë§</strong> ${item.username}</p>
          <div class="password-display hidden" id="pass-${item.id}"><strong>üîë</strong> ${item.password}</div>
          <div class="quick-actions">
            <button class="btn btn-secondary" data-action="copy-username" data-value="${item.username}">üìã User</button>
            <button class="btn btn-secondary" data-action="copy-password" data-value="${item.password}">üìã Pass</button>
            <button class="btn btn-secondary" data-action="toggle" data-id="${item.id}">üëÅÔ∏è Show</button>
            <button class="btn btn-danger" data-action="delete" data-id="${item.id}">üóëÔ∏è</button>
          </div>
        `;
        div.querySelectorAll('button[data-action]').forEach(b=>b.addEventListener('click', handlePasswordAction));
        grid.appendChild(div);
      });

      container.innerHTML='';
      container.appendChild(grid);
    }

    function handlePasswordAction(e){
      const action = e.target.dataset.action;
      const id = e.target.dataset.id;
      const val = e.target.dataset.value;
      if(action==='toggle') togglePassword(id, e.target);
      else if(action==='copy-password') copyToClipboard(val,'password');
      else if(action==='copy-username') copyToClipboard(val,'username');
      else if(action==='delete') deletePasswordSafe(id);
    }

    function togglePassword(id, button){
      const el = document.getElementById(`pass-${id}`);
      if(!el) return;
      if(el.classList.contains('hidden')){ el.classList.remove('hidden'); button.textContent='üôà Hide'; }
      else { el.classList.add('hidden'); button.textContent='üëÅÔ∏è Show'; }
    }

    async function deletePasswordSafe(passwordId){
      if (isOperationInProgress) {
        showAlert('Another operation is in progress. Please wait.');
        return;
      }
      
      const passwordIndex = passwords.findIndex(p => p.id === passwordId);
      if(passwordIndex === -1){ 
        showAlert('Password not found'); 
        return; 
      }
      
      const password = passwords[passwordIndex];
      const name = password.siteName;
      
      // Use custom confirmation dialog instead of native confirm()
      const confirmed = await showCustomConfirm(
        'üóëÔ∏è Delete Password',
        `Are you sure you want to delete the password for "${name}"? This action cannot be undone.`
      );
      
      if(!confirmed) return;

      try{
        isOperationInProgress = true;
        updateSyncStatus('üîÑ Deleting...','sync-offline');
        
        // First, sync with remote to get latest state
        try {
          await loadPasswordsFromGitHub();
          // Re-find the password after sync (index might have changed)
          const updatedIndex = passwords.findIndex(p => p.id === passwordId);
          if(updatedIndex === -1) {
            showAlert('Password was already deleted or not found after sync.');
            return;
          }
        } catch(syncErr) {
          console.warn('Could not sync before delete, proceeding with local state:', syncErr);
        }
        
        // Remove password from array
        const finalIndex = passwords.findIndex(p => p.id === passwordId);
        if(finalIndex === -1) {
          showAlert('Password not found after sync.');
          return;
        }
        
        const deletedPassword = passwords.splice(finalIndex, 1)[0];
        newPasswordsThisSession.delete(passwordId);
        
        // Save to GitHub with improved conflict resolution
        await savePasswordsToGitHub();
        
        // Update display
        displayPasswords();
        showCopyFeedback('üóëÔ∏è Password deleted successfully');
        
      }catch(err){
        console.error('Delete operation failed:', err);
        
        // Provide more specific error messages
        let errorMessage = 'Failed to delete password. ';
        if(String(err.message).includes('409')) {
          errorMessage += 'There was a sync conflict. Please try again.';
        } else if(String(err.message).includes('403')) {
          errorMessage += 'Permission denied. Check your GitHub token.';
        } else if(String(err.message).includes('404')) {
          errorMessage += 'Repository not found. Check your GitHub settings.';
        } else {
          errorMessage += 'Please check your internet connection and try again.';
        }
        
        showAlert(errorMessage);
        
        // Attempt to restore the password
        try {
          // Reload from GitHub to get the current state
          await loadPasswordsFromGitHub();
          displayPasswords();
          showCopyFeedback('‚ö†Ô∏è Delete failed - data restored from sync');
        } catch(restoreErr) {
          console.error('Failed to restore from GitHub:', restoreErr);
          // As last resort, restore the deleted password locally
          if(password) {
            passwords.splice(Math.max(0, passwordIndex), 0, password);
            displayPasswords();
            showCopyFeedback('‚ö†Ô∏è Delete failed - password restored locally');
          }
        }
      } finally {
        isOperationInProgress = false;
        updateSyncStatus('üü¢ Ready','sync-online');
      }
    }

    async function copyToClipboard(text, type){
      try{
        await navigator.clipboard.writeText(text);
        showCopyFeedback(type==='password' ? 'üîë Password copied!' : 'üë§ Username copied!');
      }catch(_){
        showAlert('Failed to copy to clipboard');
      }
    }

    function showCopyFeedback(msg){
      const el = document.getElementById('copyFeedback');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(()=>el.classList.remove('show'), 2000);
    }

    function generatePassword(){
      const length = 16;
      const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+=[]{}|;:,.<>?';
      let out = '';
      for(let i=0;i<length;i++) out += chars.charAt(Math.floor(Math.random()*chars.length));
      document.getElementById('password').value = out;
      showCopyFeedback('üé≤ Password generated!');
    }

    function filterPasswords(){
      const q = document.getElementById('searchInput').value.toLowerCase();
      const clearBtn = document.getElementById('clearSearch');
      if(q){
        clearBtn.classList.remove('hidden');
        filteredPasswords = passwords.filter(p =>
          p.siteName.toLowerCase().includes(q) ||
          p.username.toLowerCase().includes(q) ||
          (p.siteUrl && p.siteUrl.toLowerCase().includes(q))
        );
      }else{
        clearBtn.classList.add('hidden');
        filteredPasswords = [];
      }
      displayPasswords();
    }

    function clearSearch(){
      document.getElementById('searchInput').value='';
      document.getElementById('clearSearch').classList.add('hidden');
      filteredPasswords = [];
      displayPasswords();
    }

    async function syncNow(){
      if (isOperationInProgress) {
        showAlert('Another operation is in progress. Please wait.');
        return;
      }
      
      const btn = document.getElementById('syncBtn');
      btn.disabled=true; btn.textContent='üîÑ Syncing...';
      
      try{
        isOperationInProgress = true;
        
        // Check if we have local changes
        const currentHash = calculatePasswordsHash();
        const hasLocalChanges = currentHash !== lastSyncHash;
        
        if (hasLocalChanges) {
          // We have local changes - need to merge with remote
          updateSyncStatus('üîÑ Merging changes...','sync-offline');
          
          try {
            // First get remote state
            const remoteFile = await githubApiCall('contents/passwords.json');
            const remoteRaw = atob(remoteFile.content);
            const remoteEncrypted = JSON.parse(remoteRaw);
            const remoteJson = await decrypt(remoteEncrypted, masterKey);
            const remotePasswords = JSON.parse(remoteJson);
            
            // Merge remote with local
            const originalLocal = [...passwords];
            passwords = mergePasswordArrays(remotePasswords, passwords);
            
            // Save merged result
            await savePasswordsToGitHub();
            
            const addedCount = passwords.length - originalLocal.length;
            if(addedCount > 0) {
              showCopyFeedback(`üîÑ Synced - ${addedCount} new passwords from remote`);
            } else {
              showCopyFeedback('üîÑ Local changes saved to remote');
            }
            
          } catch(mergeErr) {
            console.warn('Could not merge with remote, saving local changes only:', mergeErr);
            // Just save local changes
            await savePasswordsToGitHub();
            showCopyFeedback('üîÑ Local changes saved');
          }
        } else {
          // No local changes, safe to load remote updates
          const originalCount = passwords.length;
          await loadPasswordsFromGitHub();
          
          const newCount = passwords.length - originalCount;
          if(newCount > 0) {
            showCopyFeedback(`üîÑ Synced - ${newCount} new passwords loaded`);
          } else if(newCount < 0) {
            showCopyFeedback(`üîÑ Synced - ${Math.abs(newCount)} passwords removed remotely`);
          } else {
            showCopyFeedback('üîÑ Already up to date');
          }
        }
        
        // Clear new password indicators after successful sync
        newPasswordsThisSession.clear();
        displayPasswords();
        
      }catch(err){
        console.error('Sync failed', err);
        
        let errorMessage = 'Sync failed. ';
        if(String(err.message).includes('403')) {
          errorMessage += 'Check your GitHub token permissions.';
        } else if(String(err.message).includes('404')) {
          errorMessage += 'Repository not found.';
        } else {
          errorMessage += 'Check your internet connection.';
        }
        
        showAlert(errorMessage);
        updateSyncStatus('üî¥ Sync Error','sync-offline');
      }finally{
        isOperationInProgress = false;
        btn.disabled=false; 
        btn.textContent='üîÑ Sync';
      }
    }

    async function logout(){
      const confirmed = await showCustomConfirm(
        'üîí Lock Vault',
        'Lock your vault? You will need to enter your master password again.'
      );
      
      if(!confirmed) return;
      
      masterKey = null;
      passwords = [];
      filteredPasswords = [];
      lastSyncTime = null;
      lastSyncHash = '';
      newPasswordsThisSession.clear();
      document.getElementById('authSection').classList.remove('hidden');
      document.getElementById('mainSection').style.display='none';
      updateSyncStatus('üîí Locked','sync-offline');
      document.getElementById('searchInput').value='';
      document.getElementById('clearSearch').classList.add('hidden');
    }

    function resetConfig(){
      const confirmed = showCustomConfirm(
        '‚ö†Ô∏è Reset Configuration',
        'Reset GitHub configuration? You will need to set it up again.'
      );
      
      if(!confirmed) return;
      
      localStorage.removeItem('githubConfig');
      githubConfig = null;
      location.reload();
    }

    // csv import export
    async function handleCSVImport(){
      const file = document.getElementById('csvImport').files[0];
      if(!file) return;

      try{
        updateSyncStatus('üîÑ Syncing before import','sync-offline');
        await loadPasswordsFromGitHub();

        const text = await file.text();
        const imported = parseCSV(text);

        if(imported.length===0){
          showAlert('No valid rows found. Expected headers: name,website,username,secondary_username,password,notes');
          return;
        }

        const confirmed = await showCustomConfirm(
          'üì• Import CSV',
          `Import ${imported.length} passwords? They will be added to existing passwords.`
        );
        
        if(!confirmed) return;

        const startLen = passwords.length;
        imported.forEach(pwd => {
          pwd.id = generatePasswordId();
          newPasswordsThisSession.add(pwd.id);
        });
        passwords.push(...imported);

        await savePasswordsToGitHub();
        displayPasswords();
        showCopyFeedback('üì• CSV imported');
      }catch(err){
        console.error('Import failed', err);
        showAlert('Import failed. Please check file format and try again.');
      }
    }

    function exportCSV(){
      if(passwords.length===0){ showAlert('No passwords to export'); return; }
      const csv = [
        'name,website,username,password,notes',
        ...passwords.map(p=>{
          const name = (p.siteName||'').replace(/,/g,'');
          const website = (p.siteUrl||'').replace(/,/g,'');
          const user = (p.username||'').replace(/,/g,'');
          const pass = (p.password||'').replace(/,/g,'');
          const notes = `Added ${new Date(p.dateAdded).toLocaleDateString()}`;
          return `"${name}","${website}","${user}","${pass}","${notes}"`;
        })
      ].join('\n');

      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `passwords-export-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showCopyFeedback('üì§ CSV exported');
    }

    function parseCSV(text){
      const lines = text.replace(/\r/g,'').trim().split('\n');
      if(lines.length<2) return [];
      // headers expected: name,website,username,secondary_username,password,notes
      const out = [];
      for(let i=1;i<lines.length;i++){
        const cols = parseCSVLine(lines[i]);
        if(cols.length<5) continue;
        const siteName = (cols[0]||'').trim();
        const website = (cols[1]||'').trim();
        const username = (cols[2]||'').trim();
        const password = (cols[4]||'').trim();
        if(!siteName || !username || !password) continue;
        const entry = {
          siteName,
          username,
          password,
          dateAdded: new Date().toISOString()
        };
        if(website){
          let url = website;
          if(url && !/^https?:\/\//i.test(url)) url = 'https://' + url;
          entry.siteUrl = url;
        }
        out.push(entry);
      }
      return out;
    }

    function parseCSVLine(line){
      const res=[]; let cur=''; let q=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch==='\"'){ q=!q; }
        else if(ch===',' && !q){ res.push(cur.trim()); cur=''; }
        else { cur+=ch; }
      }
      res.push(cur.trim());
      return res;
    }

    // Enhanced timers with conflict detection
    setInterval(()=>{ 
      if(masterKey && document.visibilityState==='visible' && !isOperationInProgress){ 
        const currentHash = calculatePasswordsHash();
        if (currentHash !== lastSyncHash) {
          // We have local changes, save them instead of loading
          savePasswordsToGitHub().catch(err => {
            console.error('Auto-save failed:', err);
          });
        } else {
          // No local changes, safe to load remote updates
          loadPasswordsFromGitHub().catch(err => {
            console.error('Auto-sync failed:', err);
          });
        }
      } 
    }, 5*60*1000);

    let inactivityTimer;
    function resetInactivityTimer(){
      clearTimeout(inactivityTimer);
      if(masterKey){
        inactivityTimer = setTimeout(()=>{
          logout();
          showAlert('Session expired due to inactivity.');
        }, 15*60*1000);
      }
    }
    document.addEventListener('click', resetInactivityTimer);
    document.addEventListener('keypress', resetInactivityTimer);
    document.addEventListener('touchstart', resetInactivityTimer);
  </script>
</body>
</html>
